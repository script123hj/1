-- Services
local Players = game:GetService("Players")
local Player = Players.LocalPlayer
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TeleportService = game:GetService("TeleportService")

-- Bi·∫øn to√†n c·ª•c
_G.Grabfruit = true  -- Lu√¥n b·∫≠t auto farm
_G.AutoStoreFruit = true  -- Lu√¥n b·∫≠t auto store
local HasJoinedMarines = false
local MarinesJoinedTime = 0

--------------------------------------------------------------------
-- H√ÄM JOIN MARINES
--------------------------------------------------------------------
local function JoinMarines()
    if HasJoinedMarines then return end
    pcall(function()
        if ReplicatedStorage:FindFirstChild("Remotes") and ReplicatedStorage.Remotes:FindFirstChild("CommF_") then
            ReplicatedStorage.Remotes.CommF_:InvokeServer("SetTeam", "Marines")
            HasJoinedMarines = true
            MarinesJoinedTime = tick()  -- L∆∞u th·ªùi ƒëi·ªÉm join Marines
            print("‚úÖ ƒê√£ join Marines th√†nh c√¥ng!")
        else
            print("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y remote ƒë·ªÉ join Marines")
        end
    end)
end

--------------------------------------------------------------------
-- H√ÄM HOP SERVER
--------------------------------------------------------------------
local function Hop()
    print("üîç ƒêang t√¨m server ƒë·ªÉ hop...")
    pcall(function()
        for count = math.random(1, math.random(40, 75)), 100 do
            local remote = ReplicatedStorage:FindFirstChild("__ServerBrowser")
            if remote then
                local serverList = remote:InvokeServer(count)
                if serverList then
                    for serverId, serverData in next, serverList do
                        if tonumber(serverData['Count']) and tonumber(serverData['Count']) < 12 then
                            print("üéØ T√¨m th·∫•y server c√≥ " .. serverData['Count'] .. " ng∆∞·ªùi. ƒêang hop...")
                            TeleportService:TeleportToPlaceInstance(game.PlaceId, serverId)
                            return
                        end
                    end
                end
            else
                print("‚ùå Kh√¥ng t√¨m th·∫•y __ServerBrowser")
                break
            end
        end
        print("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y server ph√π h·ª£p ƒë·ªÉ hop")
    end)
end

--------------------------------------------------------------------
-- H√ÄM STORE FRUIT (l∆∞u tr·ªØ fruit)
--------------------------------------------------------------------
local function StoreFruit()
    pcall(function()
        -- Ki·ªÉm tra delay 2s sau khi join Marines
        if HasJoinedMarines and (tick() - MarinesJoinedTime) < 2 then
            return
        end
        
        local backpack = Player.Backpack
        if not backpack then return end
        
        for _, tool in pairs(backpack:GetChildren()) do
            if tool:IsA("Tool") and string.find(tool.Name, "Fruit") then
                local originalName = tool:GetAttribute("OriginalName")
                if originalName then
                    ReplicatedStorage.Remotes.CommF_:InvokeServer("StoreFruit", originalName, tool)
                    print("üì¶ ƒê√£ l∆∞u fruit: " .. tool.Name)
                end
            end
        end
    end)
end

--------------------------------------------------------------------
-- AUTO STORE FRUIT SYSTEM
--------------------------------------------------------------------
local function AutoStoreAllFruits()
    while task.wait(0.2) do
        -- Ki·ªÉm tra delay 2s sau khi join Marines
        if HasJoinedMarines and (tick() - MarinesJoinedTime) < 2 then
            continue
        end
        
        if _G.AutoStoreFruit then
            pcall(function()
                local v1355 = game:GetService("Players").LocalPlayer
                local v1356 = v1355.Character or v1355.CharacterAdded:Wait()
                local v1357 = v1355:WaitForChild("Backpack")
                
                local fruitList = {
                    {"Rocket Fruit", "Rocket-Rocket"},
                    {"Spin Fruit", "Spin-Spin"},
                    {"Blade Fruit", "Blade-Blade"},
                    {"Spring Fruit", "Spring-Spring"},
                    {"Bomb Fruit", "Bomb-Bomb"},
                    {"Smoke Fruit", "Smoke-Smoke"},
                    {"Spike Fruit", "Spike-Spike"},
                    {"Flame Fruit", "Flame-Flame"},
                    {"Eagle Fruit", "Eagle-Eagle"},
                    {"Ice Fruit", "Ice-Ice"},
                    {"Sand Fruit", "Sand-Sand"},
                    {"Dark Fruit", "Dark-Dark"},
                    {"Diamond Fruit", "Diamond-Diamond"},
                    {"Light Fruit", "Light-Light"},
                    {"Rubber Fruit", "Rubber-Rubber"},
                    {"Creation Fruit", "Creation-Creation"},
                    {"Ghost Fruit", "Ghost-Ghost"},
                    {"Magma Fruit", "Magma-Magma"},
                    {"Quake Fruit", "Quake-Quake"},
                    {"Buddha Fruit", "Buddha-Buddha"},
                    {"Love Fruit", "Love-Love"},
                    {"Spider Fruit", "Spider-Spider"},
                    {"Sound Fruit", "Sound-Sound"},
                    {"Phoenix Fruit", "Phoenix-Phoenix"},
                    {"Portal Fruit", "Portal-Portal"},
                    {"Lightning Fruit", "Lightning-Lightning"},
                    {"Pain Fruit", "Pain-Pain"},
                    {"Blizzard Fruit", "Blizzard-Blizzard"},
                    {"Gravity Fruit", "Gravity-Gravity"},
                    {"Mammoth Fruit", "Mammoth-Mammoth"},
                    {"T-Rex Fruit", "T-Rex-T-Rex"},
                    {"Dough Fruit", "Dough-Dough"},
                    {"Shadow Fruit", "Shadow-Shadow"},
                    {"Venom Fruit", "Venom-Venom"},
                    {"Gas Fruit", "Gas-Gas"},
                    {"Control Fruit", "Control-Control"},
                    {"Spirit Fruit", "Spirit-Spirit"},
                    {"Leopard Fruit", "Leopard-Leopard"},
                    {"Yeti Fruit", "Yeti-Yeti"},
                    {"Kitsune Fruit", "Kitsune-Kitsune"},
                    {"Dragon Fruit", "Dragon-Dragon"}
                }
                
                for _, fruitData in ipairs(fruitList) do
                    local fruitName = fruitData[1]
                    local fruitCode = fruitData[2]
                    
                    local fruitTool = v1357:FindFirstChild(fruitName) or v1356:FindFirstChild(fruitName)
                    if fruitTool then
                        ReplicatedStorage.Remotes.CommF_:InvokeServer("StoreFruit", fruitCode, fruitTool)
                        print("üì¶ Auto store: " .. fruitName)
                        break
                    end
                end
            end)
        end
    end
end

--------------------------------------------------------------------
-- AUTO FARM FRUITS
--------------------------------------------------------------------
local function AutoFarmFruits()
    while wait(0.1) do
        -- Ki·ªÉm tra delay 2s sau khi join Marines
        if HasJoinedMarines and (tick() - MarinesJoinedTime) < 2 then
            continue
        end
        
        if _G.Grabfruit then
            local foundFruit = false
            
            -- T√¨m fruit trong Workspace
            for _, child in pairs(game.Workspace:GetChildren()) do
                if string.find(child.Name, "Fruit") and child:FindFirstChild("Handle") then
                    foundFruit = true
                    
                    -- Di chuy·ªÉn ƒë·∫øn fruit
                    local char = Player.Character
                    if char and char:FindFirstChild("HumanoidRootPart") then
                        char.HumanoidRootPart.CFrame = child.Handle.CFrame
                        wait(0.5) -- ƒê·ª£i m·ªôt ch√∫t ƒë·ªÉ thu th·∫≠p
                    end
                    break
                end
            end
            
            -- N·∫øu kh√¥ng t√¨m th·∫•y fruit, check l·∫°i sau
            if not foundFruit then
                wait(1)
            end
        end
    end
end

--------------------------------------------------------------------
-- STORE FRUIT AUTO (th∆∞·ªùng xuy√™n ki·ªÉm tra v√† l∆∞u)
--------------------------------------------------------------------
local function AutoStoreLoop()
    while wait(3) do  -- Ki·ªÉm tra m·ªói 3 gi√¢y
        -- Ki·ªÉm tra delay 2s sau khi join Marines
        if HasJoinedMarines and (tick() - MarinesJoinedTime) < 2 then
            continue
        end
        
        StoreFruit()
    end
end

--------------------------------------------------------------------
-- KH·ªûI CH·∫†Y T·∫§T C·∫¢ T√çNH NƒÇNG
--------------------------------------------------------------------
print("üöÄ B·∫Øt ƒë·∫ßu script Auto Farm Blox Fruits")
print("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê")

-- 1. Join Marines ngay l·∫≠p t·ª©c
task.spawn(function()
    wait(1)
    JoinMarines()
    
    -- ƒê·ª£i 2s sau khi join Marines r·ªìi m·ªõi b·∫Øt ƒë·∫ßu farm/store
    wait(2)
    print("‚úÖ ƒê√£ qua 2s delay sau khi join Marines, b·∫Øt ƒë·∫ßu farm/store")
end)

-- 2. Auto Hop Server sau 5 gi√¢y
task.spawn(function()
    wait(5)  -- ƒê√£ s·ª≠a t·ª´ 10s th√†nh 5s
    print("‚è∞ T·ª± ƒë·ªông hop server sau 5 gi√¢y...")
    Hop()
end)

-- 3. Kh·ªüi ch·∫°y Auto Farm Fruits (c√≥ delay check)
task.spawn(function()
    wait(3)  -- Th√™m delay 3s tr∆∞·ªõc khi b·∫Øt ƒë·∫ßu farm
    AutoFarmFruits()
end)

-- 4. Kh·ªüi ch·∫°y Auto Store Fruits (c√≥ delay check)
task.spawn(function()
    wait(3)  -- Th√™m delay 3s tr∆∞·ªõc khi b·∫Øt ƒë·∫ßu store
    AutoStoreAllFruits()
end)

-- 5. Kh·ªüi ch·∫°y Auto Store Loop (d·ª± ph√≤ng)
task.spawn(function()
    wait(3)  -- Th√™m delay 3s
    AutoStoreLoop()
end)

-- 6. Manual Hop Command (d√πng trong console)
_G.HopServer = function()
    Hop()
end

-- 7. Manual Store Command (d√πng trong console)
_G.StoreAllFruits = function()
    StoreFruit()
end

--------------------------------------------------------------------
-- HI·ªÇN TH·ªä TH√îNG TIN
--------------------------------------------------------------------
print("‚úÖ ƒê√£ kh·ªüi ch·∫°y t·∫•t c·∫£ t√≠nh nƒÉng:")
print("   ‚Ä¢ Auto Join Marines (sau 1s)")
print("   ‚Ä¢ Auto Farm Fruits (sau delay 2s t·ª´ khi join Marines)")
print("   ‚Ä¢ Auto Store Fruits (sau delay 2s t·ª´ khi join Marines)")
print("   ‚Ä¢ Auto Hop Server (sau 5s)")
print("")
print("üéÆ C√°c l·ªánh trong console:")
print("   _G.HopServer() - Hop server th·ªß c√¥ng")
print("   _G.StoreAllFruits() - L∆∞u fruits th·ªß c√¥ng")
print("")
print("üìù Script ƒëang ch·∫°y...")

--------------------------------------------------------------------
-- KI·ªÇM TRA REMOTE
--------------------------------------------------------------------
task.spawn(function()
    wait(2)
    if not ReplicatedStorage:FindFirstChild("__ServerBrowser") then
        print("‚ö†Ô∏è C·∫£nh b√°o: Kh√¥ng t√¨m th·∫•y __ServerBrowser, ch·ª©c nƒÉng hop c√≥ th·ªÉ kh√¥ng ho·∫°t ƒë·ªông")
    end
    
    if not ReplicatedStorage:FindFirstChild("Remotes") then
        print("‚ö†Ô∏è C·∫£nh b√°o: Kh√¥ng t√¨m th·∫•y Remotes folder")
    end
end)

--------------------------------------------------------------------
-- AUTO REJOIN KHI TELEPORT TH·∫§T B·∫†I
--------------------------------------------------------------------
TeleportService.TeleportInitFailed:Connect(function()
    print("‚ùå Teleport th·∫•t b·∫°i, th·ª≠ l·∫°i sau 5 gi√¢y...")
    wait(5)
    Hop()
end)

--------------------------------------------------------------------
-- KI·ªÇM TRA V√Ä C·∫¨P NH·∫¨T LI√äN T·ª§C
--------------------------------------------------------------------
task.spawn(function()
    local lastCheck = tick()
    
    while wait(30) do
        local currentTime = tick()
        local timeSinceJoin = currentTime - MarinesJoinedTime
        
        print("üìä Script ƒëang ho·∫°t ƒë·ªông...")
        print("   ‚Ä¢ Place ID: " .. game.PlaceId)
        print("   ‚Ä¢ Joined Marines: " .. tostring(HasJoinedMarines))
        
        if HasJoinedMarines then
            print("   ‚Ä¢ Time since join Marines: " .. string.format("%.1f", timeSinceJoin) .. "s")
            
            -- Hi·ªÉn th·ªã tr·∫°ng th√°i delay
            if timeSinceJoin < 2 then
                print("   ‚Ä¢ Status: ƒêang delay 2s sau join Marines (" .. string.format("%.1f", 2 - timeSinceJoin) .. "s c√≤n l·∫°i)")
            else
                print("   ‚Ä¢ Status: ƒê√£ qua delay, ƒëang farm/store")
            end
        end
        
        print("   ‚Ä¢ Auto Farm: " .. tostring(_G.Grabfruit))
        print("   ‚Ä¢ Auto Store: " .. tostring(_G.AutoStoreFruit))
    end
end)
